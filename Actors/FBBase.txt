Class FB_HitFlash : Actor
{
 Default
  {
   +BRIGHT
   +NOINTERACTION
   +FORCEXYBILLBOARD
   RenderStyle "Stencil";
  }
 States
  {
  Spawn:
  "####" A 2 A_Warp(AAPTR_MASTER,frandom(-3,3),frandom(-3,3),frandom(-3,3),flags:WARPF_NOCHECKPOSITION|WARPF_INTERPOLATE);
   Stop;
  }
}

Class FB_FairyBase : Actor
{
  int spritetype;
  int attacktype;
  int attackloop;
  Default
  {
    Health 20;
    Radius 16;
    Height 30;
    Mass 50;
    MeleeRange 100;
	MeleeThreshold 180;
    Speed 3;
    Scale 1;
	Painchance 128;
    Tag "Fairy";
    Monster;
    StencilColor "White";
    +DONTHARMCLASS
    +NOGRAVITY
    +FLOAT
    +FLOATBOB
    +DONTFALL
    +NOICEDEATH
	+AVOIDMELEE
	FloatBobStrength 0.5;
	BloodType "FB_MagicBlood";
	//MinMissileChance 240;
	//TeleFogSourceType "PM_SmallDemonicTeleportFog";
	//TeleFogDestType "PM_SmallDemonicTeleportFog";
  }

   protected void HitSound()
  {
   switch(fb_hitsfx)
   {
    case 0: A_StartSound("FB/RaizingHit",CHAN_AUTO,0,0.9); break;
	case 1: A_StartSound("FB/StardustArenaHit",CHAN_AUTO,0,0.9); break;
   }
  }

 /*override void Tick()
  {
	super.tick();
	
	flashtimer--;	
	    
  }*/

  override int DamageMobj(Actor inflictor, Actor source, int damage, Name mod, int flags, double angle)
	{
    int dmg = super.DamageMobj(inflictor, source, damage, mod, flags, angle);
	CVar hitflashenabled = CVar.FindCVar('fb_hitflash');
	
    if(hitflashenabled.GetInt() && dmg > 0)
	{
		HitSound();
		A_SpawnItemEx("FB_HitFlash",flags:SXF_SETMASTER|SXF_TRANSFERSCALE|SXF_TRANSFERSTENCILCOL|SXF_TRANSFERSPRITEFRAME);
	}
	
	return dmg;
	}
  
  state FairyChoose(statelabel s1, statelabel s2, statelabel s3, statelabel s4, statelabel s5, statelabel s6, statelabel s7, statelabel s8, statelabel s9, statelabel s10, statelabel s11, statelabel s12)
  {
   switch(attacktype)
   {
    case 1: return ResolveState(s1); break;
	case 2: return ResolveState(s2); break;
	case 3: return ResolveState(s3); break;
	case 4: return ResolveState(s4); break;
	case 5: return ResolveState(s5); break;
	case 6: return ResolveState(s6); break;
	case 7: return ResolveState(s7); break;
	case 8: return ResolveState(s8); break;
	case 9: return ResolveState(s9); break;
	case 10: return ResolveState(s10); break;
	case 11: return ResolveState(s11); break;
	case 12: return ResolveState(s12); break;
   }
   return ResolveState(null);
  }

  override void PostBeginPlay()
	{
	 tex[0] = TexMan.CheckForTexture("DTPRA0",TexMan.Type_Sprite);
	 tex[1] = TexMan.CheckForTexture("DTPRB0",TexMan.Type_Sprite);
	 tex[2] = TexMan.CheckForTexture("SPKOE0",TexMan.Type_Sprite);
	 tex[3] = TexMan.CheckForTexture("SPKPE0",TexMan.Type_Sprite);
	 tex[4] = TexMan.CheckForTexture("DTPRR0",TexMan.Type_Sprite);
	 tex[5] = TexMan.CheckForTexture("SPKGE0",TexMan.Type_Sprite);
	}
	
	TextureID tex[6];

  States
  {
  Spawn:
    FA_1 AB 5 A_Look();
    Loop;
  See:
    FA_1 AABB 1 A_Chase();
    Loop;
  WanderAttack:
	FA_1 AABBAABBAABBAABBAABB 1
	{
		A_Chase("Missile","Missile",CHF_DONTMOVE);
		A_Wander();
		A_FaceTarget();
	}
	FA_1 A 0 A_CheckSight("See");
	Loop;
  Realign:
	FA_1 AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB 1 A_Wander();
	Goto See;
  Missile:
	TNT1 A 0 A_CheckLOF("MissileProceed");
    Goto Realign;
  MissileProceed:
  Bullet1:
    TNT1 A 0 { attackloop = random(-2,0); }
	FA_1 A 3 
	{
	if(attackloop <= 0)
	SetStateLabel("Cooldown");
	A_SpawnProjectile("FB_FairyBall1",10);
	}
	Loop;
  Melee:
    FA_1 AABB 1;
    Goto CoolDown;
  CoolDown:
	FA_1 AABBAABBAABB 1 A_Wander();
	Goto WanderAttack;
  Pain:
	FA_1 A 1;
	FA_1 A 1 A_Pain();
	FA_1 A 4; 
	Goto See;
  Death:
    TNT1 A 0;
	FA_1 A 1 A_Scream();
	FA_1 A 1 A_NoBlocking();
  DeathFade:
	FA_1 A 1 A_FadeOut(0.1);
    Loop;
  }
}